# Interface Whitelist - Single Source of Truth for Model I/O & Governance

**Version**: v7.1  
**Last Updated**: 2025-10-28  
**Purpose**: Define the canonical contracts between Core Model and external components (Adapter, Decision, Execution)

---

## 1. Overview

This document establishes the **Interface Whitelist** as the single source of truth for:
- Model inputs and outputs
- Validation metrics contracts
- Governance thresholds and policies
- Adapter component boundaries

All implementations must conform to the contracts defined here. Any deviation requires updating this document first.

---

## 2. Core Model Inputs

### 2.1 Data Loader Contract
**Schema Reference**: `governance/SCHEMA_data.json`

#### Required Fields
- `features`: DataFrame with columns as defined in feature schema
- `timestamps`: UTC timestamps aligned to bar boundaries
- `metadata`: Dictionary containing:
  - `symbol`: String
  - `timeframe`: String (e.g., "1m", "5m")
  - `exchange`: String

#### Data Quality Requirements
- No missing values in feature columns
- Timestamps must be monotonically increasing
- All numeric features must be finite (no inf/-inf)

### 2.2 Feature Schema
**Schema Reference**: `governance/SCHEMA_features.json`

#### Core Features (Model-Required)
These features are computed by Core and consumed directly by the model:
- `bar_vpo_imbalance`: Volume profile imbalance
- `bar_vpo_absorption`: Volume profile absorption
- `cvd_rolling`: Cumulative volume delta (rolling)
- `volprofile_skew`: Volume profile skewness

#### Macro Context Features
- `macro_regime`: Regime indicator
- `volatility_slope`: Volatility trend indicator

---

## 3. Core Model Outputs

### 3.1 Clustering Outputs
**Schema Reference**: `governance/SCHEMA_model.json`

#### Artifacts
- `labels_wt.parquet`: Cluster labels with weights
  - Columns: `timestamp`, `label`, `weight`, `clarity`
- `cluster_artifacts.json`: Cluster metadata
  - `prototypes`: Cluster centroids
  - `label_alignment`: A/B label mapping
  - `drift_metrics`: Prototype drift history

### 3.2 Transition Probability Outputs
**Schema Reference**: `governance/SCHEMA_model.json`

#### Artifacts
- `transition_prob.parquet`: State transition probabilities
  - Columns: `timestamp`, `prob_A_to_B`, `prob_B_to_A`, `clarity`, `abstain_flag`

### 3.3 Validation Metrics
**Schema Reference**: `governance/SCHEMA_validation.json`

#### Core Metrics (Must be produced by validation/core/)
- `prototype_drift`: Scaled Euclidean drift of cluster centroids
- `ece`: Expected Calibration Error
- `brier`: Brier score
- `abstain_rate`: Rate of abstain decisions
- `transition_hit_ratio`: Accuracy of transition predictions

#### V7.1 Stability Metrics
- `noise_energy`: Energy in noise components during low clarity
- `drift_bandwidth`: Bandwidth proxy using first-order differences
- `clarity_spectrum_power`: High-frequency power in clarity spectrum
- `adversarial_gap`: Robustness to input perturbations

#### Output Format
- `validation/metrics_summary.json`: All metrics in JSON format
- `validation/VALIDATION.md`: Human-readable report (optional, generated by adapter)

---

## 4. Governance Contracts

### 4.1 Single Threshold Source
**Authority**: `governance/CONTROL_switch_policy.yaml`

All threshold values MUST be read from this file. No other configuration files should define thresholds.

#### Threshold Categories
- **Transition Policy**: `transition_prob.gate`
- **Clarity Gates**: `clarity.warn`, `clarity.fail`
- **Drift Gates**: `prototype_drift.warn`, `prototype_drift.fail`
- **Calibration Gates**: `ece.warn/fail`, `brier.warn/fail`
- **Abstain Policy**: `abstain_rate.min/max`
- **Performance Gates**: `transition_hit_ratio.min`
- **Stability Gates**: `stability_index.threshold`, `noise_energy.threshold`, etc.

### 4.2 Gate Evaluation
Gates are evaluated in the following order:
1. **Critical Gates** (must pass for release):
   - `prototype_drift < fail`
   - `ece < fail`
   - `brier < fail`
   - `stability_index >= threshold`
   - `noise_energy <= threshold`

2. **Warning Gates** (monitored but non-blocking):
   - `drift_bandwidth < warn`
   - `clarity_spectrum_power < warn`
   - `adversarial_gap < warn`

3. **Performance Gates**:
   - `abstain_rate` in [min, max]
   - `transition_hit_ratio >= min`

### 4.3 Abstain Policy
**Reference**: `governance/CONTROL_switch_policy.yaml` → `abstain_policy`

Conditions triggering abstain:
- `clarity < clarity_gate` (0.45)
- `prototype_drift > drift_gate` (0.15)

Reasons recorded in decision output:
- `clarity_below_threshold`
- `prototype_drift_exceeds_gate`

---

## 5. Core vs Adapter Boundaries

### 5.1 Core Responsibilities (Must remain in Core)
- Clustering algorithm implementation
- Transition probability computation
- Core metric calculation (4 stability metrics + calibration metrics)
- Gate evaluation logic
- Abstain decision logic

### 5.2 Adapter Responsibilities (External to Core)
- Rich report generation (charts, HTML, detailed markdown)
- Data preprocessing and alignment
- Feature engineering (derived features, cross-window dependencies)
- Audit and operational scripts
- Integration with external systems

### 5.3 Interface Points
Core exposes minimal, stable interfaces:
- **Input**: Standardized feature DataFrame (schema-validated)
- **Output**: Parquet files with metrics, JSON summaries
- **Configuration**: Read from governance YAML files only

Adapter components:
- **Cannot** modify core algorithm behavior
- **Can** transform data to meet input schema
- **Can** enrich output artifacts with visualizations
- **Must** respect all governance constraints

---

## 6. Deprecation Policy

### 6.1 Interface Changes
Any change to interfaces defined in this document requires:
1. Version bump in schema files
2. Deprecation notice (minimum 2 releases)
3. Update to this whitelist document
4. Migration guide in `docs/MIGRATION_NOTES.md`

### 6.2 Legacy Import Paths
Legacy import paths (pre-separation) will emit `DeprecationWarning`:
- `from features.noise_metrics import *` → Use `from features.core.noise_metrics import *`
- `from validation import compute_*` → Use `from validation.core import compute_*`

Compatibility shims will be maintained for 2 releases after separation.

---

## 7. Validation & Compliance

### 7.1 Schema Validation
All I/O must validate against schemas in `governance/SCHEMA_*.json`:
- Data inputs validate against `SCHEMA_data.json`
- Feature outputs validate against `SCHEMA_features.json`
- Model outputs validate against `SCHEMA_model.json`
- Validation metrics validate against `SCHEMA_validation.json`

### 7.2 Threshold Governance
**CRITICAL**: `governance/CONTROL_switch_policy.yaml` is the ONLY source for thresholds.

Any code reading thresholds from other files (e.g., `validation/thresholds.yaml`) must be updated to read from `CONTROL_switch_policy.yaml`.

### 7.3 CI/CD Enforcement
CI pipeline enforces:
- Schema validation passes
- Minimal pipeline (`make validate`) runs using core-only paths
- All gate checks pass before release
- Signatures recorded for all artifacts

---

## 8. Migration Notes

### 8.1 Current State (V7.1)
- Core components: `features/core/`, `validation/core/`
- Adapter components: `features/adapter/`, `validation/adapter/`
- Compatibility shims in place at old import paths

### 8.2 Future State (V8.0)
- Adapter components moved to separate repositories:
  - `CentralDataKitchen` (CDK): Data preprocessing, feature engineering
  - `Decision`: Decision engine, directional classifier
  - `Execution`: Order execution, position management
  - `Ops`: Operational scripts, audit tools

### 8.3 Migration Support
See `docs/MIGRATION_NOTES.md` for detailed migration roadmap and adapter offloading list.

---

## 9. References

- **Architecture**: `docs/ARCHITECTURE.md`
- **Data Pipeline**: `docs/DATA_PIPELINE.md`
- **Validation Guide**: `validation/VALIDATION.md`
- **Migration Guide**: `docs/MIGRATION_NOTES.md`
- **Governance Schemas**: `governance/SCHEMA_*.json`
- **Control Policies**: `governance/CONTROL_switch_policy.yaml`

---

## 10. Signatures

**Document Version**: 1.0  
**Schema Version**: v7.1  
**Last Reviewed**: 2025-10-28  
**Reviewers**: Architecture Committee, Governance Team  
**Status**: Active

---

*This document is the authoritative source for all interface contracts. Any implementation that deviates from these contracts is considered non-compliant and must be corrected.*
